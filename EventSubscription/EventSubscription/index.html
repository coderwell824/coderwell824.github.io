<!DOCTYPE html>
<html>
	<head>
		
<title>手写发布订阅模式-个人博客</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<link rel="stylesheet" href="/css/index.css">


<meta name="keywords" content="个人博客">
<meta name="description" content="描述">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.initHighlightingOnLoad();</script>

	<meta name="generator" content="Hexo 6.2.0"></head>

	<body>
		
	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										首页
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										汇总
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										分类
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										文章标签
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>陈栓</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">首页</a>
        </li>
        
        <li>
            <a href="/archives">汇总</a>
        </li>
        
        <li>
            <a href="/categories">分类</a>
        </li>
        
        <li>
            <a href="/tags">文章标签</a>
        </li>
        
        <li>
            <a href="/links"></a>
        </li>
        
        <li>
            <a href="/about"></a>
        </li>
        
    </ul>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 0;
        height: 100%;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815)
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					width: "66%"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					width: "0"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-color"
    style="background: url('')" 
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
        </ul>
        
        <h1>手写发布订阅模式</h1>
        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                        <g>
                            <path fill="#12183A"
                                d="M6.187 15.265A6.47 6.47 0 0 0 10 16.5a6.47 6.47 0 0 0 3.813-1.235A4.99 4.99 0 0 0 10 13.5a4.99 4.99 0 0 0-3.813 1.765zM5.082 14.25A6.485 6.485 0 0 1 10 12c1.965 0 3.726.872 4.918 2.25a6.5 6.5 0 1 0-9.836 0zM10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-1.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z">
                            </path>
                        </g>
                    </svg>
                
                <span class="post-header-info-author-text"> <a href="../../about">陈栓</a></span>
                <div class="post-header-info-author-categories">
                    
                         <a href="../../categories/Javascript/" target="_blank" >Javascript</a>
                    
                </div>
                <p>2023-02-24 00:00:00</p>
            </div>
        </div>
    </div>
</div>
    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    

    <h1 id="发布订阅模式的定义"><a href="#发布订阅模式的定义" class="headerlink" title="发布订阅模式的定义"></a>发布订阅模式的定义</h1><p>首先说明一下什么是发布-订阅模式都由统一的一个调度中心来处理, 那也就是说这个模式是由三部分组成的</p>
<p>发布者: 将消息事件发布到调度中心</p>
<p>订阅者: 把自己想关注的消息事件, 注册到调度中心</p>
<p>调度中心: 处理事件注册与发布</p>
<img src="http://lc-llAarrZL.cn-n1.lcfile.com/qptpsyOs9dm886K8Jf8XzCgTPWG5zwaj/image-20230301175521145.png" alt=" " style="zoom:50%;" />

<h2 id="发布订阅模式的思路"><a href="#发布订阅模式的思路" class="headerlink" title="发布订阅模式的思路"></a>发布订阅模式的思路</h2><p>定义一个事件变量对象来存储消息事件, 因为订阅者不止一个</p>
<p>定义一个添加方法, 将事件添加到事件变量对象中</p>
<p>定义一个删除方法, 将事件在事件变量对象中删除</p>
<p>定义一个派发方法, 调用事件变量对象中的事件</p>
<pre><code class="javascript">class EventSubscription&#123;

  constructor()&#123;
    //定义事件容器, 用来存储事件数组
    this.eventObject=&#123;&#125;
  &#125;

  //事件添加方法
  addEventListener()&#123;

  &#125;

  //派发方法
  dispatchEvent()&#123;

  &#125;

  //事件移除方法
  removeEventListener()&#123;

  &#125;
&#125;
</code></pre>
<h2 id="addEventListener事件添加方法"><a href="#addEventListener事件添加方法" class="headerlink" title="addEventListener事件添加方法"></a>addEventListener事件添加方法</h2><p>添加消息事件是需要一个事件名以及消息事件的事件回调函数</p>
<p>需要将消息事件添加到事件变量对象中, 并且不止一个变量</p>
<p>添加事件变量时需要判断是否存在当前事件, 做不同的处理</p>
<pre><code class="javascript">  /**
   * @description:事件添加方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; callback 事件回调函数
   */
  addEventListener (eventName, callback) &#123;

    //判断事件变量对象中是否存在当前事件, 如果没有的话初始化一个空数组
    if (!this.eventObject[eventName]) &#123;
      this.eventObject[eventName] = []
    &#125; else &#123;
      //如果存在, 那就说明该事件有多个订阅者, 继续往后push
      this.eventObject[eventName].push(callback)
    &#125;
  &#125;
</code></pre>
<h2 id="removeEventListener事件移除方法"><a href="#removeEventListener事件移除方法" class="headerlink" title="removeEventListener事件移除方法"></a>removeEventListener事件移除方法</h2><p>删除消息事件是需要一个事件名的, 以及消息事件的事件回调函数</p>
<p>在事件变量对象中, 对应的事件回调函数不止一个, 需要对符合条件的callback进行删除</p>
<p>如果事件回调函数不存在的话, 直接删除事件</p>
<pre><code class="javascript">  /**
   * @description: 移除事件方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; callback 事件回调函数
   */
  removeEventListener (eventName, callback) &#123;

    //判断该事件在事件变量对象中是否存在
    if (!this.eventObject[eventName]) &#123;
      return new Error(&quot;事件无效&quot;)
    &#125;

    //事件回调函数不存在直接移除该事件的订阅和发布
    if (!callback) &#123;
      delete this.eventObject[eventName]
    &#125; else &#123;

      //移除事件
      const index = this.eventObject[eventName].findIndex(item =&gt; item === callback);
      if (index === -1) return new Error(&quot;无该绑定事件&quot;)
      this.eventObject[eventName].splice(index, 1)

      //无事件回调函数移除该事件的订阅和发布
      if (!this.eventObject[eventName].length) &#123;
        delete this.eventObject[eventName];
      &#125;
    &#125;
  &#125;
</code></pre>
<h2 id="diapatchEvent事件派发方法"><a href="#diapatchEvent事件派发方法" class="headerlink" title="diapatchEvent事件派发方法"></a>diapatchEvent事件派发方法</h2><p>事件派发方法只需要方法名, 确定是哪个事件, 也可以传递参数</p>
<p>将事件变量对象中对应的事件回调函数依次执行</p>
<pre><code class="javascript">  /**
   * @description: 派发方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; params 参数
   */
  dispatchEvent (eventName, params) &#123;

    //若没有注册该事件则抛出错误
    if (!this.eventObject[eventName]) &#123;
      return new Error(&quot;该事件未注册&quot;)
    &#125;

    //触发事件
    this.eventObject[eventName].forEach((callback) =&gt; &#123;
      callback(...params)
    &#125;)
  &#125;
</code></pre>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><pre><code class="javascript">class EventSubscription &#123;

  constructor() &#123;
    //定义事件容器, 用来存储事件数组
    this.eventObject = &#123;&#125;
  &#125;

  /**
   * @description:事件添加方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; callback 事件回调函数
   */
  addEventListener (eventName, callback) &#123;

    //判断事件变量对象中是否存在当前事件, 如果没有的话初始化一个空数组
    if (!this.eventObject[eventName]) &#123;
      this.eventObject[eventName] = []
    &#125; else &#123;
      //如果存在, 那就说明该事件有多个订阅者, 继续往后push
      this.eventObject[eventName].push(callback)
    &#125;
  &#125;

  /**
   * @description: 移除事件方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; callback 事件回调函数
   */
  removeEventListener (eventName, callback) &#123;

    //判断该事件在事件变量对象中是否存在
    if (!this.eventObject[eventName]) &#123;
      return new Error(&quot;事件无效&quot;)
    &#125;

    //事件回调函数不存在直接移除该事件的订阅和发布
    if (!callback) &#123;
      delete this.eventObject[eventName]
    &#125; else &#123;

      //移除事件
      const index = this.eventObject[eventName].findIndex(item =&gt; item === callback);
      if (index === -1) return new Error(&quot;无该绑定事件&quot;)
      this.eventObject[eventName].splice(index, 1)

      //无事件回调函数移除该事件的订阅和发布
      if (!this.eventObject[eventName].length) &#123;
        delete this.eventObject[eventName];
      &#125;
    &#125;
  &#125;

  /**
   * @description: 派发方法
   * @param &#123;*&#125; eventName 事件名
   * @param &#123;*&#125; params 参数
   */
  dispatchEvent (eventName, params) &#123;

    //若没有注册该事件则抛出错误
    if (!this.eventObject[eventName]) &#123;
      return new Error(&quot;该事件未注册&quot;)
    &#125;

    //触发事件
    this.eventObject[eventName].forEach((callback) =&gt; &#123;
      callback(...params)
    &#125;)
  &#125;
&#125;
</code></pre>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><pre><code class="javascript">const eventSubscription = new EventSubscription();

function test1 (params) &#123;
  console.log(&quot;测试test1:&quot;, params);
&#125;
function test2 (params) &#123;
  console.log(&quot;测试test2:&quot;, params);
&#125;

// 添加订阅内容
eventSubscription.addEventListener(&#39;test&#39;, test1);
eventSubscription.addEventListener(&#39;test&#39;, test2);
console.dir(eventSubscription)
// 输出结果
// EventSubscription &#123;
//     eventObject: &#123; test: [ [Function: test1], [Function: test2] ] &#125;
// &#125;

// 派发订阅事件
eventSubscription.dispatchEvent(&#39;test&#39;, &#39;tests事件触发&#39;)
// 输出结果
// 测试test1: tests事件触发
// 测试test2: tests事件触发

// 删除订阅事件
eventSubscription.removeEventListener(&#39;test&#39;, test2)
console.log(eventSubscription)
// 输出结果: EventSubscription &#123; eventObject: &#123; test: [ [Function: test1] ] &#125; &#125;

eventSubscription.dispatchEvent(&#39;test&#39;)
console.log(eventSubscription)
// 输出结果: EventSubscription &#123; eventObject: &#123;&#125; &#125;
</code></pre>

  </div>
  <div id="gitalk-container"></div>
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    

    
    <a href="/createRoot/createRoot/">
        <div class="post-paging-next">
            <span>下一篇</span>
            <p>React源码剖析:createRoot函数1</p>
        </div>
    </a>
    
</div>
</div>
	</body>
</html>

